<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Power BI Pro Embebido</title>
    <script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.23.1/dist/powerbi.min.js"></script>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>#reportContainer{height:80vh;width:100%;border:1px solid #ccc;}</style>
</head>
<body>
    <h1>Reporte embebido Power BI</h1>
    <div id="reportContainer"></div>
    <div id="errorDisplay" style="color: red; margin-top: 1em;"></div>

    <script>
        console.log("Iniciando embebido de Power BI...");
        if (typeof window.powerbi === 'undefined') {
            console.error("SDK de Power BI no encontrado.");
            document.getElementById("errorDisplay").innerText = "SDK de Power BI no encontrado.";
        } else {
            const models = window['powerbi-client']?.models || window.powerbi?.models;
            if (!models) {
                console.error("Modelos de Power BI no disponibles.");
                document.getElementById("errorDisplay").innerText = "Modelos de Power BI no disponibles.";
            } else {
                const config = {
                    type: 'report',
                    tokenType: models.TokenType.Aad,
                    accessToken: '{{ embed_token }}',
                    embedUrl: '{{ embed_url }}',
                    id: '{{ report_id }}',
                    settings: {
                        panes: {
                            filters: { visible: true },
                            pageNavigation: { visible: true }
                        },
                        bars: {
                            statusBar: { visible: true }
                        },
                        hideErrors: false
                    }
                };

                console.log("Configuración de incrustación:", config);
                let container = document.getElementById("reportContainer");

                try {
                    const report = powerbi.embed(container, config);
                    console.log("Embed invocado correctamente.");

                    report.off("loaded");
                    report.on("loaded", function () {
                        console.log("Evento 'loaded': el informe se inicializó.");
                    });

                    report.off("rendered");
                    report.on("rendered", function () {
                        console.log("Evento 'rendered': el informe se renderizó.");
                    });

                    report.off("error");
                    report.on("error", function (event) {
                        console.error("Evento 'error':", event.detail);
                        document.getElementById("errorDisplay").innerText = "Error al renderizar Power BI: " + event.detail?.message;
                    });
                } catch (e) {
                    console.error("Excepción al intentar incrustar:", e);
                    document.getElementById("errorDisplay").innerText = "Excepción en el embed: " + e.message;
                }
            }
        }
    </script>
</body>
</html>
