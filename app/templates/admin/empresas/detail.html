{% extends "layout.html" %}

{% block title %}{{ title }} - PowerBI Embed Admin{% endblock %}

{% block body %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-building me-2"></i>{{ title }}</h2>
    <div>
      <a href="{{ url_for('empresas.edit', empresa_id=empresa.id) }}" class="btn btn-primary">
        <i class="bi bi-pencil me-1"></i> Editar
      </a>
      <a href="{{ url_for('empresas.list') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Volver
      </a>
    </div>
  </div>

  <div class="row">
    <!-- Main Information -->
    <div class="col-md-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Información General</h5>
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-3">ID:</dt>
            <dd class="col-sm-9">{{ empresa.id }}</dd>
            
            <dt class="col-sm-3">Nombre:</dt>
            <dd class="col-sm-9"><strong>{{ empresa.nombre }}</strong></dd>
            
            <dt class="col-sm-3">CUIT:</dt>
            <dd class="col-sm-9">{{ empresa.cuit or 'No especificado' }}</dd>
            
            <dt class="col-sm-3">Estado:</dt>
            <dd class="col-sm-9">
              {% if empresa.estado_activo %}
              <span class="badge bg-success">Activa</span>
              {% else %}
              <span class="badge bg-secondary">Inactiva</span>
              {% endif %}
            </dd>
            
            <dt class="col-sm-3">Client ID:</dt>
            <dd class="col-sm-9">
              <code class="small">{{ empresa.client_id }}</code>
              <button class="btn btn-sm btn-outline-secondary ms-2" 
                      onclick="copyToClipboard('{{ empresa.client_id }}')" 
                      title="Copiar al portapapeles">
                <i class="bi bi-clipboard"></i>
              </button>
            </dd>
            
            <dt class="col-sm-3">Creado:</dt>
            <dd class="col-sm-9">{{ empresa.created_at.strftime('%Y-%m-%d %H:%M:%S') if empresa.created_at else 'N/A' }}</dd>
            
            <dt class="col-sm-3">Última actualización:</dt>
            <dd class="col-sm-9">{{ empresa.updated_at.strftime('%Y-%m-%d %H:%M:%S') if empresa.updated_at else 'N/A' }}</dd>
          </dl>
        </div>
      </div>

      <!-- Associated Reports -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-file-earmark-bar-graph me-2"></i>Reportes Asociados ({{ empresa.report_configs|length }})</h5>
          <a href="{{ url_for('empresas.manage_reports', empresa_id=empresa.id) }}" 
             class="btn btn-sm btn-success">
            <i class="bi bi-plus-circle me-1"></i> Gestionar Reportes
          </a>
        </div>
        <div class="card-body">
          {% if empresa.report_configs %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Nombre Config</th>
                  <th>Report</th>
                  <th>Workspace</th>
                  <th>Tipo</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for config in empresa.report_configs %}
                <tr>
                  <td>{{ config.id }}</td>
                  <td><strong>{{ config.name }}</strong></td>
                  <td>{{ config.report.name }}</td>
                  <td>{{ config.workspace.name }}</td>
                  <td>
                    {% if config.es_publico %}
                    <span class="badge bg-success">Público</span>
                    {% endif %}
                    {% if config.es_privado %}
                    <span class="badge bg-info">Privado</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <div class="btn-group" role="group">
                      <a href="{{ url_for('configs.detail', config_id=config.id) }}" 
                         class="btn btn-sm btn-outline-info" title="Ver Detalles">
                        <i class="bi bi-info-circle"></i>
                      </a>
                      <a href="{{ url_for('configs.view', config_id=config.id) }}" 
                         class="btn btn-sm btn-outline-primary" title="Ver Reporte">
                        <i class="bi bi-eye"></i>
                      </a>
                      <a href="{{ url_for('configs.edit', config_id=config.id) }}" 
                         class="btn btn-sm btn-outline-secondary" title="Editar">
                        <i class="bi bi-pencil"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="alert alert-warning mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No hay reportes asociados a esta empresa. 
            <a href="{{ url_for('empresas.manage_reports', empresa_id=empresa.id) }}">Gestionar reportes</a> 
            para asociar configuraciones.
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Actions Sidebar -->
    <div class="col-md-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>Acciones Rápidas</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="{{ url_for('empresas.edit', empresa_id=empresa.id) }}" 
               class="btn btn-outline-primary">
              <i class="bi bi-pencil me-2"></i>Editar Empresa
            </a>
            
            <a href="{{ url_for('empresas.manage_reports', empresa_id=empresa.id) }}" 
               class="btn btn-outline-success">
              <i class="bi bi-file-earmark-bar-graph me-2"></i>Gestionar Reportes
            </a>
            
            <form method="POST" action="{{ url_for('empresas.toggle_status', empresa_id=empresa.id) }}" 
                  style="display:inline;">
              <button type="submit" class="btn btn-outline-warning w-100">
                <i class="bi bi-{% if empresa.estado_activo %}pause-circle{% else %}play-circle{% endif %} me-2"></i>
                {% if empresa.estado_activo %}Desactivar{% else %}Activar{% endif %} Empresa
              </button>
            </form>
            
            <hr>
            
            <button type="button"
                    class="btn btn-outline-info w-100 regenerate-btn"
                    data-action="{{ url_for('empresas.regenerate_credentials', empresa_id=empresa.id) }}">
              <i class="bi bi-arrow-clockwise me-2"></i>Regenerar Credenciales
            </button>
            
            <button type="button"
                    class="btn btn-outline-danger w-100 delete-empresa-btn"
                    data-action="{{ url_for('empresas.delete', empresa_id=empresa.id) }}"
                    data-nombre="{{ empresa.nombre }}">
              <i class="bi bi-trash me-2"></i>Eliminar Empresa
            </button>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Estadísticas</h6>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Reportes Asociados:</span>
            <span class="badge bg-primary fs-6">{{ empresa.report_configs|length }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">Estado:</span>
            {% if empresa.estado_activo %}
            <span class="badge bg-success fs-6">Activa</span>
            {% else %}
            <span class="badge bg-secondary fs-6">Inactiva</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Copy to clipboard with SweetAlert notification
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    showSuccess('Client ID copiado al portapapeles');
  }, function(err) {
    showError('Error al copiar el Client ID');
    console.error('Error al copiar: ', err);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  // Regenerate credentials confirmation
  const regenerateBtn = document.querySelector('.regenerate-btn');
  if (regenerateBtn) {
    regenerateBtn.addEventListener('click', function() {
      const action = this.dataset.action;
      
      Swal.fire({
        title: '¿Regenerar credenciales?',
        text: 'Las credenciales antiguas dejarán de funcionar inmediatamente.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#f39c12',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, regenerar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true,
        focusCancel: true
      }).then((result) => {
        if (result.isConfirmed) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = action;
          document.body.appendChild(form);
          form.submit();
        }
      });
    });
  }
  
  // Delete empresa confirmation
  const deleteBtn = document.querySelector('.delete-empresa-btn');
  if (deleteBtn) {
    deleteBtn.addEventListener('click', function() {
      const action = this.dataset.action;
      const nombre = this.dataset.nombre;
      
      Swal.fire({
        title: '¿Está seguro?',
        html: `¿Desea eliminar la empresa <strong>"${nombre}"</strong>?<br><small class="text-muted">Esta acción no se puede deshacer.</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true,
        focusCancel: true
      }).then((result) => {
        if (result.isConfirmed) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = action;
          document.body.appendChild(form);
          form.submit();
        }
      });
    });
  }
});
</script>
{% endblock %}
